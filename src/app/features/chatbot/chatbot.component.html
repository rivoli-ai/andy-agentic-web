<div class="h-full flex bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
  <!-- Sessions Sidebar -->
  <div class="flex-shrink-0 bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm border-r border-slate-200/50 dark:border-slate-700/50 shadow-lg transition-all duration-300"
       [class.w-80]="isSessionPanelOpen"
       [class.w-16]="!isSessionPanelOpen">
    
         <!-- Sidebar Header -->
     <div class="flex items-center justify-between p-4 border-b border-slate-200/50 dark:border-slate-700/50">
       <div class="flex items-center space-x-3">
         <div *ngIf="isSessionPanelOpen" class="flex-1">
           <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-300">Sessions</h2>
           <p class="text-xs text-slate-500 dark:text-slate-400">Chat history</p>
         </div>
       </div>
      
                           <!-- Toggle Button -->
        <button
          (click)="toggleSessionPanel()"
          class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-all duration-200 border border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500"
          title="Toggle sidebar"
        >
          <svg *ngIf="isSessionPanelOpen" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
          </svg>
          <svg *ngIf="!isSessionPanelOpen" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
          </svg>
        </button>
    </div>

         <!-- Sidebar Content -->
     <div *ngIf="isSessionPanelOpen" class="flex-1 w-80 flex flex-col min-h-0">
       <!-- Agent Info -->
       <div *ngIf="selectedAgent" class="flex-shrink-0 p-4 border-b border-slate-200/50 dark:border-slate-700/50">
         <div class="flex items-center space-x-3">
           <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-xs font-semibold text-white">
             {{ getAgentAvatar(selectedAgent) }}
           </div>
           <div class="flex-1 min-w-0">
             <p class="text-sm font-medium text-slate-700 dark:text-slate-300 truncate">
               {{ selectedAgent.name }}
             </p>
             <p class="text-xs text-slate-500 dark:text-slate-400">Active Agent</p>
           </div>
         </div>
         
         <!-- New Session Button -->
         <button
           (click)="startNewSession()"
           [disabled]="isLoading"
           class="w-full mt-3 inline-flex items-center justify-center px-3 py-2 bg-green-500 hover:bg-green-600 disabled:bg-green-300 text-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 disabled:cursor-not-allowed text-sm"
           title="Start new chat session"
         >
           <svg *ngIf="!isLoading" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
           </svg>
           <svg *ngIf="isLoading" class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
           </svg>
           New Session
         </button>
       </div>

               <!-- Sessions List -->
        <div class="flex-1 overflow-hidden min-h-0 flex flex-col">
          <!-- Loading State -->
          <div *ngIf="isLoadingSessions" class="flex items-center justify-center py-8">
            <svg class="w-6 h-6 animate-spin text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span class="ml-2 text-slate-600 dark:text-slate-400">Loading...</span>
          </div>

                                           <!-- Sessions -->
            <div *ngIf="!isLoadingSessions" class="flex-1 overflow-y-auto ">
                             <div *ngIf="chatSessions.length === 0" class="text-center py-8 text-slate-500 dark:text-slate-400">
                 <svg class="w-12 h-12 mx-auto mb-3 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                 </svg>
                 <p class="text-sm">No sessions yet</p>
                 <p class="text-xs">Start chatting to create one</p>
               </div>
               
               <div class="space-y-2 p-2 min-h-0 max-h-[26rem] sm:max-h-[26rem] md:max-h-[28rem] lg:max-h-[32rem] xl:max-h-[15rem] 2xl:max-h-[37rem] overflow-hidden overflow-y-auto scrollbar-hide">
             <div  
               *ngFor="let session of chatSessions; trackBy: trackBySession"
               (click)="switchToSession(session.sessionId)"
               class="session-item group p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-slate-100 dark:hover:bg-slate-700 border border-transparent w-80"
               [class.current-session]="isCurrentSession(session.sessionId)"
               [class.bg-blue-50]="isCurrentSession(session.sessionId)"
               [class.border-blue-200]="isCurrentSession(session.sessionId)"
             >
              <div class="flex items-start space-x-3">
                <!-- Status Indicator -->
                <div class="w-2 h-2 rounded-full mt-2 flex-shrink-0"
                     [class.bg-green-500]="isCurrentSession(session.sessionId)"
                     [class.bg-slate-400]="!isCurrentSession(session.sessionId)">
                </div>
                
                <!-- Session Content -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300 truncate">
                      {{ session.agentName }}
                    </span>
                  
                  </div>
                  
                  <!-- Description -->
                  <div *ngIf="session.description" class="text-sm text-slate-700 dark:text-slate-200 mb-2 line-clamp-2 bg-slate-50 dark:bg-slate-700/30 px-2 py-1 rounded border-l-2 border-blue-300 dark:border-blue-500">
                    {{ session.description }}
                  </div>
                  
                  <!-- Metadata -->
                  <div class="text-xs text-slate-500 dark:text-slate-500">
                    {{ getSessionTime(session.lastActivityAt) }} â€¢ {{ session.messageCount }} messages
                  </div>
                </div>
                
                <!-- Action Buttons (Hidden by default, shown on hover) -->
                <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button
                    (click)="renameSession(session, $event)"
                    class="p-1 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 rounded transition-colors"
                    title="Rename session"
                  >
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                  </button>
                  
                  <button
                    (click)="deleteSession(session.sessionId, $event)"
                    class="p-1 text-slate-400 hover:text-red-600 dark:hover:text-red-400 rounded transition-colors"
                    title="Delete session"
                  >
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

         <!-- Collapsed State -->
     <div *ngIf="!isSessionPanelOpen" class="flex-1 flex flex-col items-center py-4">
       <div *ngIf="selectedAgent" class="text-center">
         <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-xs font-semibold text-white mb-2">
           {{ getAgentAvatar(selectedAgent) }}
         </div>
         <button
           (click)="startNewSession()"
           [disabled]="isLoading"
           class="p-2 bg-green-500 hover:bg-green-600 disabled:bg-green-300 text-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 disabled:cursor-not-allowed"
           title="New Session"
         >
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
           </svg>
         </button>
       </div>
       
       
     </div>
  </div>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col">


         <!-- Chat Messages -->
     <div class="flex-1 overflow-hidden">
       <div class="w-full h-full">
         <div 
           #chatContainer
           class="h-full overflow-y-auto space-y-6 scroll-smooth p-4"
         >
          <!-- Welcome Message -->
          <div *ngIf="messages.length === 0" class="flex items-center justify-center h-full">
            <div class="text-center space-y-4">
              <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900/20 dark:to-purple-900/20 rounded-full flex items-center justify-center mx-auto">
                <svg class="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-slate-700 dark:text-slate-300">
                Welcome to AI Chat!
              </h3>
              <p class="text-slate-500 dark:text-slate-400 max-w-md">
                Navigate to an agent from the agents list and click the chat button to start chatting. Your conversations will be streamed in real-time with beautiful formatting.
              </p>
            </div>
          </div>

          <!-- Messages -->
          <div *ngFor="let message of messages; trackBy: trackByMessage" class="animate-fade-in">
            <!-- User Message -->
            <div *ngIf="message.isUser" class="flex justify-end">
              <div class="max-w-4xl w-full">
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl px-6 py-4 shadow-lg">
                  <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                      <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <p class="text-sm font-medium">You</p>
                      <p class="text-sm mt-1 leading-relaxed">{{ message.content }}</p>
                    </div>
                  </div>
                  <div class="text-xs text-blue-100 mt-2 text-right">
                    {{ message.timestamp | date:'HH:mm' }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Agent Message -->
            <div *ngIf="!message.isUser" class="flex justify-start">
              <div class="max-w-4xl w-full">
                <div class="bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 rounded-2xl px-6 py-4 shadow-lg">
                  <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-purple-400 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                      <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center space-x-2 mb-2">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">
                          {{ message.agentName }}
                        </span>
                        <span class="inline-flex items-center space-x-1">
                          <span *ngIf="message.isStreaming" class="text-xs text-slate-500 dark:text-slate-400">I'm receiving...</span>
                          <span *ngIf="!message.isStreaming" class="text-xs text-slate-500 dark:text-slate-400">Completed</span>
                          <span class="text-xs text-blue-500 font-mono ml-2">
                            {{ message.content.length || 0 }} chars
                          </span>
                        </span>
                      </div>
                      
                      <!-- Content (Streaming or Final) -->
                      <div class="prose prose-sm dark:prose-invert max-w-none relative group">
                        <div 
                          markdown 
                          clipboard
                          mermaid
                          [mermaidOptions]="options"
                          [data]="message.content">
                        </div>
                         
                        <button
                          (click)="copyMessageContent(message.content)"
                          class="absolute top-2 right-2 p-2 bg-slate-700/80 hover:bg-slate-600/80 text-white rounded-lg transition-colors duration-200 opacity-0 group-hover:opacity-100"
                          title="Copy content"
                        >
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                          </svg>
                        </button>
                      </div>
                      
                      <!-- Status Bar (Always Visible) -->
                      <div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                        <div class="flex items-center space-x-2">
                          <div *ngIf="message.isStreaming" class="loading-dots text-blue-500">
                            <div></div>
                            <div></div>
                            <div></div>
                          </div>
                          <span *ngIf="message.isStreaming" class="text-xs text-slate-500 dark:text-slate-400">Streaming...</span>
                          <span *ngIf="!message.isStreaming" class="text-xs text-slate-500 dark:text-slate-400">Completed</span>
                        </div>
                        <div class="text-xs text-slate-400 dark:text-slate-500 font-mono">
                          {{ message.content.length || 0 }} characters received
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="text-xs text-slate-500 dark:text-slate-400 mt-3 text-right">
                    {{ message.timestamp | date:'HH:mm' }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Streaming Indicator -->
          <div *ngIf="isExecuting && !hasStreamingMessages()" class="flex justify-start animate-fade-in">
            <div class="max-w-4xl w-full">
              <div class="bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 rounded-2xl px-6 py-4 shadow-lg">
                <div class="flex items-start space-x-3">
                  <div class="w-8 h-8 bg-gradient-to-br from-purple-400 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-2">
                      <span class="text-sm font-medium text-slate-700 dark:text-slate-300">
                        {{ selectedAgent?.name }}
                      </span>
                      <div class="loading-dots text-blue-500">
                        <div></div>
                        <div></div>
                        <div></div>
                      </div>
                    </div>
                    <p class="text-sm text-slate-500 dark:text-slate-400">
                      Thinking...
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div class="flex-shrink-0 p-4">
      <div class="w-full">
        <!-- Session Indicator -->
        <div *ngIf="selectedAgent && currentSessionId" class="mb-3 flex items-center justify-between">
          <div class="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
            <span>Active Session</span>
            <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full">
              {{ currentSessionId.substring(0, 8) }}...
            </span>
          </div>
          
          <button
            (click)="startNewSession()"
            [disabled]="isLoading"
            class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 hover:underline transition-colors"
            title="Start new session"
          >
            + New Session
          </button>
        </div>

        <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50 rounded-2xl shadow-lg">
          <form [formGroup]="chatForm" (ngSubmit)="onSubmit()" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 p-4">
            <div class="flex-1 relative">
              <input
                type="text"
                formControlName="message"
                placeholder="Type your message..."
                class="w-full px-6 py-4 border border-slate-300 dark:border-slate-600 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-base transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                [disabled]="!selectedAgent || isExecuting"
              />
              <div *ngIf="!selectedAgent" class="absolute inset-0 bg-slate-50 dark:bg-slate-800 rounded-xl flex items-center justify-center">
                <span class="text-slate-500 dark:text-slate-400 text-sm">
                  Please select an agent to start chatting
                </span>
              </div>
            </div>
            
            <button
              type="submit"
              [disabled]="!selectedAgent || chatForm.invalid || isExecuting"
              class="inline-flex items-center justify-center px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 transform hover:scale-105 active:scale-95"
            >
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
              </svg>
              Send
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
